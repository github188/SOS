## SangforTool使用

### **作用：**

1. 实现模拟多分支并发接入总部，更真实更方便，易于人工控制，更能方便测试结果检查

### **工具原理：**

1. 基于现有lmdlan服务开发的，配置操作与分支配置一样，无任何区别，后台服务程序也是lmdlan
2. 启停方式为/etc/init.d/lmdlan start or stop
3. lmdlan配置路径：/etc/sinfor/dlan/
4. N多分支与总部数据互访是基于lmdlan原本功能-&gt;隧道间路由实现

### 使用方法：

* #### 工具辅助脚本：

  ```
  脚本说明：tool_vpn_gen.sh sangfor 命令后，能根据脚本提示引导配置步骤，以更简单的方式去执行，无需知道每个参数是干什么
  脚本参数说明:
  tool_vpn_gen.sh参数说明:
  测试设备的总部的webagent配置:   ------------------>测试总部的基本设置
  被测试设备上用户管理的用户名：   ------------------>已经导入总部用户管理用户名,如果选择不启用多用户,用户名会以递增方式添加
  被测试设备上用户的密码：         ------------------>建议都输入密码
  工具端的内网网段（如网段2.2.2.0）：    -------------->分支的内网网段,会根据掩码的方式去递增
  工具段的内网网段掩码（如掩码：255.255.255.0）：   ---->分支内网掩码
  测试工具标记（参考ABCDEFG）：                   ----->区分不用的环境使用参数,如果一致会导致后面的测试工具分支接入失败
  测试工具标记起始位置(直接输入1)；                ----->与上面一致，会递增，如A1----A100
  本段的vpn虚拟ip(如：12.12.12.1)：              ------>分支的VPN虚拟IP,也是会自动递增的,不同测试工具不能一样
  VPN传输模式(0:TCP;1:UDP)：                     ----->分支的传输模式,当前只支持tcp和upd
  VPN传输模式封堵模式(0->不启用,1->自动,2->TCP,3->ESP,默认不启用)：  -----默认不勾选
  VPN启用多用户(1是不启用,0是启用,建议选择1)：     ------>如启用的话,总部的用户需要勾选多用户功能,不然会导致VPN接入失败            
  被测试设备总部内网网段（如：111.111.111.0）：    ------>测试总部的内网IP,必须填对,不然会导致打流不能跑向VPN隧道里
  被测试设备总部内网网段掩码（如：255.255.255.0）： ----->建议采用255.255.255.0
  VPN用户认证方式(0:非证书认证,1:证书认证)：        ----->用户的认证方式
  本地证书ID(根据工具环境证书配置id)：              
  对端根证ID(根据工具环境证书配置id)：
  ----->使用证书需要检测总部和分支的证书配置一样,这样证书就能匹配行,此ID需要跟/etc/sinfor/cers/local_cer.sfr引用证书id一样
  ```
* #### 举例说明:

  _   需求：_

```
总部为1.1.1.1:4009,总部内网111.111.111.0/24，用户为aes1到aes100,密码test123，采用预共享
并发1000个分支接入，传输模式：tcp，分支内网1.1.1.0/24开始，虚拟vpn：1.2.3.1
```

       _详细步骤：_

```
1、总部导入1000用户为AES1....AES1000且密码为test123配置 
2、测试工具执行tool_vpn_gen.sh sangfor 命令窗口提示输入每个参数信息，在输入总部用户的时候应该输入AES，
3、在后台日志/var/SangforTool.log 查看配置输出的命令
```

      _执行过程：_

```
测试设备的总部的webagent配置：1.1.1.1:4009
被测试设备上用户管理的用户名：aes
被测试设备上用户的密码：test
工具端的内网网段（如网段2.2.2.0）：1.1.1.0
工具段的内网网段掩码（如掩码：255.255.255.0）：255.255.255.0
测试工具标记（参考ABCDEFG）：A
测试工具标记起始位置(直接输入1)；1
本段的vpn虚拟ip(如：12.12.12.1)：1.2.3.1
VPN传输模式(0:TCP;1:UDP)：0
VPN传输模式封堵模式(0->不启用,1->自动,2->TCP,3->ESP,默认不启用)：0
VPN启用多用户(1是不启用,0是启用,建议选择1)：1
被测试设备总部内网网段（如：111.111.111.0）：111.111.111.0
被测试设备总部内网网段掩码（如：255.255.255.0）：255.255.255.0
VPN用户认证方式(0:非证书认证,1:证书认证)：0
本地证书ID(根据工具环境证书配置id)：0
对端根证ID(根据工具环境证书配置id)：0
需要生成多少条sangfor vpn连接：1000

输出结果：
SangforTool.sh -w 1.1.1.1:4009 -u aes -p test -n 1.1.1.0 -m 255.255.255.0 -C A -s 1 -v 1.2.3.1 -t 0 -r 0 -M 1 -l 111.111.111.0 -d 255.255.255.0 -a 0 -L 0 -R 0 -c 1000
```

### 问题定位

```
  日志：查看/var/log/messages
  问题类型：
  一、VPN服务启用后失败
  检查ipsec vpn配置是否存在，可以输入IpsecTool.sh -c 0 检查服务会不会启用成功
  二、模拟分支数据访问不了总部
  方法一：
  检查当前测试数据中源ip和目的ip地址，是否在/etc/sinfor/dlan/Router.conf配置源ip网段到目标网段包含了.没包含需要重现修改配置
  方法二：
  1、开启/etc/sinfor/SystemDefaultSet.vpn配置中参数bEnableMml为1，重启服务让其生效
  2、telnet 127.0.0.1 51981进入后输入root dlanreocver 操作页面
  3、输入debug 255后退出
  4、继续发生数据，检测/var/log/messages是检测日志打印出来结果，如输入未匹配到vpn的话，表示数据不符合vpn隧道间路由规则
```



